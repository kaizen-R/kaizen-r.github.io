---
title: "Gathering Security Data: Tests with Ansible"
author: "Nico"
date: "2021-05-08"
categories: [cyber]
---

## **Goal for today**

Gather Configuration data from Linux boxes. As the saying goes: â€œYou canâ€™t manage what you donâ€™t knowâ€. Well, today is about just that (with focus on IT Security).

## **Introduction**

This is part of a series of posts about gathering security data (see for example: [Shodan API tests](https://www.kaizen-r.com/2021/04/shodan-api-tests/) or [More external data sources tests: OWASP Amass](https://www.kaizen-r.com/2021/04/more-external-data-sources-tests-owasp-amass/)). But those where about gathering data from the Internet. Letâ€™s look â€œinwardsâ€ for once.

Iâ€™ve heard a lot the name â€œAnsibleâ€, and I understood the conceptâ€¦ But (until right now) I had not played with it. Today will, as often, only be about demo/testing, so do not expect much detail (or the best possible quality).

And no, it wonâ€™t be about R at all (once again), but rather about gathering (hopefully relevant) data for security purposes.

## Getting things working

First letâ€™s create a new container; weâ€™ll use the Alpine distro as it is lightweight and supports Ansible (<https://wiki.alpinelinux.org/wiki/Ansible>)

``` bash
docker pull alpine
```

Once installed, letâ€™s run that in interactive mode. (Weâ€™ll probably want to go the Dockerfile way in the future, but that will be good enough for today).

``` bash
docker run --name ansible1 -it alpine
```

Then weâ€™ll install Ansible, like so (weâ€™ll also need SSH, mainly):

``` bash
/ # apk add ansible
/ # apk add openssh
```

That was rather easy, wasnâ€™t it? Now we can first test access to our â€œHome Labâ€ server:

``` bash
/ # ssh -p 22225 10.0.1.10
```

Working, but of course, SSH keys and all are not there. So Iâ€™ll fix that (quick fix with bad ciphers and all, but sufficient). Not much security as I will clean this up afterwards. And weâ€™re â€œreadyâ€, inside the Home Lab Server. Letâ€™s get back to our Ansible container (which is, by the way, a so-called â€œcontrol nodeâ€).

``` bash
nico@home1:~$ exit
logout
Connection to 10.X.X.X closed.
```

Now we have an ansible-installed container, and the Home Lab Server to be â€œmanagedâ€. The Home Lab already sports a Python3 so nothing else should be needed. Thatâ€™s good.

Note for self: When working with interactive mode in Docker, you might want to pause and come back to your container later on. Then youâ€™ll need to do something along the following lines to re-connect to your container after exiting it:

``` bash
# sudo docker ps -a
# sudo docker start 1b72b31851fd
# sudo docker attach 1b72b31851fd
```

OK so, the APK worked, but some relevant files seem to be missing. For instance, I need to create the /etc/ansible directory, to then be able to add the hosts file in there.

As I use a port different from the default on my machines, I need to write the port number with the machine IP in the hosts inventory, so I put it like this (format, not what it actually looks like):

``` bash
[linux]
IP:PORT
```

The Linux tag above will allow to run the Ansible playbooks by groups, in this case on all Linux boxes (only one for our example). Then to the actual test:

``` bash
# ansible all -m ping -u nico
10.0.1.10 | SUCCESS => {
   "ansible_facts": {
     "discovered_interpreter_python": "/usr/bin/python3"
   },
   "changed": false,
   "ping": "pong"
}
```

That works! Letâ€™s test some more data-gathering with Ansible:

``` bash
ansible -m setup --tree out/ all -u nico
```

The output is too long here, but weâ€™re getting somewhere indeed.Â  Thatâ€™s essentially about hardware information. (And: No, I donâ€™t really know what Iâ€™m doing. So going to the man pages (remember, RTFM): Apparently the -m is to point to a given module, in this case â€œsetupâ€.Â  â€“tree would be to indicate the output directory. â€œallâ€ apparently is indicating to run for all hosts in the inventory, in our case just the one. The last option is to indicate the username to use for the SSH connection, in this case the one for which we have configured the SSH Keys exchange a bit earlier).

Now suppose we need to get to the software installed on a machine. Letâ€™s see how that would go:

Thankfully, weâ€™re not starting from scratch (I couldnâ€™t learn that much Ansible with my available spare time right now). So for testing purposes, Iâ€™ll use the example from here:

<https://www.jmrnet.tech/?p=26>

Youâ€™ll notice the reference to â€œhosts: linuxâ€ in there, thatâ€™s why we put a name to our group in the hosts file earlier ğŸ˜‰

``` bash
- name: Capture installed package information for Linux hosts
  hosts: linux
  tasks:
  - name: Get the package facts from hosts
   package_facts:
    manager: auto
  - name: Display output
   debug:
    var: ansible_facts.packages
```

Then we save that as a YAML file, and we run it like so:

``` bash
# ansible-playbook -u nico installed_sw_base_playbook.yml
```

An extract of the results for instance (the list is looooong too):

``` bash
[...],
"vim": [
       {
         "arch": "amd64",
         "category": "editors",
         "name": "vim",
         "origin": "Ubuntu",
         "source": "apt",
         "version": "2:8.1.2269-1ubuntu5"
       }
     ],
[...]
```

And thatâ€™s about it. We now have a list of software components installed on the Home Lab Server, along with lots of Hardware data.

Disclaimer: Right now Iâ€™ll admit, I donâ€™t exactly know HOW the commands and YAML files work just yet. It seems pretty straightfoward, but I havenâ€™t investigated any further just yet. Even then, the thing is working, for a total of maybe 1h work ğŸ™‚

## **Conclusions**

Knowing what you have (be it for IT operations or for security posture understanding, cybersecurity operations and so on) is, I believe, quite important. The â€œAnsible wayâ€ is only one potential way to go about gathering information about Linux (and apparently Windows, and probably more) servers/machines.

Plus Iâ€™ve been meaning to get started with Ansible for a long time, so I thought I would give it a data-collection/security focus for the Blog.

Ansible seems to be pretty cool indeed: Only Python is required on the managed nodes (as they seem to be called in Ansible Lingo ;)), which helps (as deploying agents on production machines is generally not a beloved approachâ€¦)

## Resources

[Ansible Official Documentation](https://docs.ansible.com/)

[The blog post I used to find a workable playbook for software inventory](https://www.jmrnet.tech/?p=26)

[Getting Ansible to work on Alpine Linux (for container)](https://wiki.alpinelinux.org/wiki/Ansible)
