---
title: "Testing Containers"
author: "Nico"
date: "2021-06-20"
categories: [cyber]
---

## Intro

Now this Post is a tiny bit different, although still about working with data, and with a focus on security.

But this time around, if you‚Äôve followed a bit the Blog, we have a few ‚ÄúDocker‚Äù containers running on different machines, to work on security data. That‚Äôs very cool, but‚Ä¶ What about the security OF these containers?¬†

### Let‚Äôs get to it

OK so the other day (weeks ago actually) a colleague showed me his Debian container was found to be insecure, and in doing so, he showed me about ‚ÄúTrivy‚Äù. So this (free) Aquasec tool is supposed to be able to detect, in seconds, some vulnerabilities in Containers images. And that‚Äôs‚Ä¶ Interesting to say the least.

In looking into it, I also came across the ‚Äúnative‚Äù alternative (well, not so native, but almost):

``` bash
docker scan
```

Function, so we might want to try that too. Docker scan however requires a Docker account and a connection, while trivy, once installed, can be run locally as far as I have been able to check.

``` bash
sudo docker pull aquasec/trivy
mkdir trivy_cache
cd trivy_cache
```

### Let‚Äôs check some containers, shall we?

``` bash
sudo docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $PWD:/root/.cache/ aquasec/trivy caffix/amass
```

![](amass_trivy_scan.png){alt=""}

Note to self: NO detection in ANY test involving Alpine containers so far‚Ä¶ Weird? Or even cooler than before (Alpine is already very lightweight‚Ä¶ Now if it also seems generally secure‚Ä¶). CVE-based detections is apparently tricky. Another colleague explained to me a bit about it, and it seems it is far from perfect. It can be prone to false-positives, and/or false-negatives, so a quick reminder: This Blog post is about ONE kind of checks, but it is NOT about EXHAUSTIVE security checks üòâ

Let‚Äôs test our latest container (upcoming posts on the subject of Postgres):

``` bash
sudo docker run --rm -v $PWD:/root/.cache/ aquasec/trivy postgres
```

Now that gives 130, 19, 32 high & 2 Critical‚Ä¶ Not cool.

So let‚Äôs try to upgrade the OS maybe? In a Dockerfile:

``` bash
FROM postgres
RUN apt-get update
RUN apt-get dist-upgrade -y
```

Let‚Äôs build that:

``` bash
sudo docker build -t local/postgres_update .
```

Then we run the command locally (using docker.sock):

``` bash
sudo docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $PWD:/root/.cache/ aquasec/trivy local/postgres_update
```

Doesn‚Äôt make any difference at all, unfortunately‚Ä¶ (And postgres was indeed upgraded, which is good, but apparently not enough‚Ä¶). Maybe I‚Äôll need to remove something from that container to improve things a bit? I don‚Äôt know. Let‚Äôs keep going

### What if we check it with ‚Äúdocker scan‚Äù instead of trivy?

So first here we need to login to Docker Hub:

``` bash
docker login
```

Then

``` bash
docker scan postgres
```

(If you see a warning about Snyk and you are CERTAIN there is nothing sensitive in your docker image, I guess it‚Äôs safe to go ahead‚Ä¶)

And indeed, a loooong output:

![](postgres_debian_scan1.png){alt=""}

The output finishes with what I consider rather bad news:¬†

![](postgres_debian_scan2.png){alt=""}

Now, with such results (and it seems to be pretty common among debian-based images out there, although I‚Äôm not certain why‚Ä¶), one would have to consider seriously whether or not to use such a container. *Again, keep in mind, CVE-based detection might not be perfect.*

Pros- & Cons-? Pro: Clearly, having a container working from a simple ‚Äúdocker pull‚Äù is great. Cons: Well, are we reaaaally exposed here?

Let‚Äôs see:

My containers run in a machine (the ‚ÄúHome Lab Server‚Äù) that is creating its own home-only small wifi network, uses a firewall (iptables) so that only ‚Äúinternal‚Äù machines correctly logged onto that Wifi can see those containers, and also‚Ä¶ Almost all that is on the Home Lab Server I actually publish on the Internet in one way or another.

So? I can still play around with this container at home. But should I need to use something similar in a different setup, I‚Äôd definitely would need to ensure it is in a controlled environment‚Ä¶ And then I looked a bit more into it. It turns out someone at the Postgres community thought it‚Äôd be cool to have an Alpine-based container‚Ä¶ Could this be the answer?

We already know Alpine-based containers are generally smaller‚Ä¶ Let‚Äôs go for it then:

``` bash
docker pull postgres:alpine
```

Up front, it‚Äôs 160 MB in size compared to 314MB‚Ä¶ Good.

But even better:¬†

![](postgres_alpine_scan.png){alt=""}

I feel (somewhat) relieved‚Ä¶ That I could use at work. (Good, I was starting to worry ;))

Also, trivy seems to agree with Docker Scan:

![](postgres_alpine_trivy_check.png){alt=""}

### Bonus

What about our RStudio Env:

``` bash
sudo docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $PWD:/root/.cache/ aquasec/trivy rocker_base003
```

3 Highs, no Critical‚Ä¶ And from Docker Scan:¬†

![](rocker_check_vulns.png){alt=""}

That‚Äôs not perfect, but with no high vulnerabilities & more dependencies checked, I‚Äôd say that‚Äôs much better than the postgres container üôÇ

### Conclusions

Using Docker is great. I am a big fan (I know, it‚Äôs obvious, if you‚Äôre a reader of the Blog). But then one needs to think of the security aspects of it all.

One (DEFINITELY NOT complete nor perfect) way to go about it is to look for more secure images. To do so, you need to be able to check whether an image has any red-flags. In CI, you would probably not want to deploy anything with known critical vulnerabilities, and so you would add a check upon deployments and stop anything looking really bad.

Once you know where you stand, you‚Äôre better off.

And now you can actually look for alternative images when you think you need to.
